name: Reusable Slack Notification

on:
  workflow_call:
    inputs:
      title:
        description: 'Short title (e.g., Stable Release, Canary Release)'
        required: true
        type: string
      status:
        description: 'Status for the notification (success|failure|info)'
        required: false
        default: 'info'
        type: string
      version:
        description: 'Version string to display (e.g., v1.2.3 or 1.2.3-canary.1)'
        required: false
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        run: |
          TITLE="${{ inputs.title }}"
          STATUS="${{ inputs.status }}"
          VERSION_INPUT="${{ inputs.version }}"

          STATUS_ICON=""
          STATUS_PREFIX=""
          case "$STATUS" in
            success)
              STATUS_ICON="✅";
              STATUS_PREFIX="succeeded";
              ;;
            failure)
              STATUS_ICON="❌";
              STATUS_PREFIX="failed";
              ;;
            *)
              STATUS_ICON="ℹ️";
              STATUS_PREFIX="update";
              ;;
          esac
          VERSION_VALUE=${VERSION_INPUT:-n/a}
          VERSION_LINE=", version ${VERSION_VALUE}"

          payload=$(cat <<EOF
          {
            "text": "${STATUS_ICON} ${TITLE} ${STATUS_PREFIX}${VERSION_LINE} in ${{ github.repository }}",
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "${STATUS_ICON} ${TITLE} ${STATUS_PREFIX}", "emoji": true }
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "See workflow details below. @group-client-libs" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Repository*\n${{ github.repository }}" },
                  { "type": "mrkdwn", "text": "*Workflow*\n${{ github.workflow }}" },
                  { "type": "mrkdwn", "text": "*Ref*\n${{ github.ref_name }}" },
                  { "type": "mrkdwn", "text": "*Actor*\n${{ github.actor }}" },
                  { "type": "mrkdwn", "text": "*Version*\n${VERSION_VALUE}" }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "View Run" },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "View Commit" },
                    "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  { "type": "mrkdwn", "text": "Commit: ${{ github.sha }}" }
                ]
              }
            ]
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$payload" ${{ secrets.SLACK_CLIENT_LIBS_WEBHOOK }}
