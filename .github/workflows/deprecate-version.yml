name: Deprecate package versions

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deprecate (e.g. 2.80.0, 2.80.0-canary.0)'
        required: true
        type: string
      message:
        description: 'Deprecation message'
        required: true
        type: string

env:
  NODE_VERSION: '20'

jobs:
  deprecate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Check if actor is member of admin or sdk team
        id: team-check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const org = 'supabase'
            const { actor } = context

            async function isTeamMember(team_slug) {
              try {
                const res = await github.rest.teams.getMembershipForUserInOrg({
                  org,
                  team_slug,
                  username: actor,
                })
                return res && res.status === 200
              } catch (_) {
                return false
              }
            }
            const isAdmin = await isTeamMember('admin')
            const isSdk = await isTeamMember('sdk')
            const isMember = isAdmin || isSdk
            core.setOutput('is_team_member', isMember ? 'true' : 'false')

      - name: Fail if not authorized
        if: ${{ steps.team-check.outputs.is_team_member != 'true' }}
        run: |
          echo "You must be a member of @supabase/admin or @supabase/sdk."
          exit 1

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Deprecate package versions
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          MESSAGE="${{ inputs.message }}"

          PACKAGES=(
            "supabase-js"
            "auth-js"
            "functions-js"
            "realtime-js"
            "storage-js"
            "postgrest-js"
            "gotrue-js"
          )

          FAILED=0

          for pkg in "${PACKAGES[@]}"; do
            FULL_PKG="@supabase/${pkg}"

            echo "============================================"
            echo "Deprecating ${FULL_PKG}@${VERSION}"
            echo "Message: ${MESSAGE}"
            echo "============================================"

            if npm deprecate "${FULL_PKG}@${VERSION}" "${MESSAGE}"; then
              echo "‚úÖ Successfully deprecated ${FULL_PKG}@${VERSION}"
            else
              echo "‚ùå Failed to deprecate ${FULL_PKG}@${VERSION}"
              FAILED=$((FAILED + 1))
            fi

            echo ""
          done

          if [ "$FAILED" -gt 0 ]; then
            echo "‚ö†Ô∏è ${FAILED} package(s) failed to deprecate."
            exit 1
          fi

          echo "üéâ All packages deprecated successfully!"

  notify-success:
    needs: deprecate
    if: success()
    uses: ./.github/workflows/slack-notify.yml
    with:
      title: 'SDK Deprecation'
      status: 'success'
      version: ${{ inputs.version }}
    secrets: inherit

  notify-failure:
    needs: deprecate
    if: failure()
    uses: ./.github/workflows/slack-notify.yml
    with:
      title: 'SDK Deprecation'
      status: 'failure'
      version: ${{ inputs.version }}
    secrets: inherit
