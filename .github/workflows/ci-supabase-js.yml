name: Supabase JS tests
# Reusable workflow - called by ci.yml (PRs) and publish.yml (master)

on:
  workflow_call:

env:
  NODE_VERSION: '20'

jobs:
  build-package:
    name: Build all packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0

      - name: Build all packages
        run: npx nx run-many --target=build --all

      - name: Upload built packages
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: packages-dist
          path: |
            packages/core/auth-js/dist
            packages/core/functions-js/dist
            packages/core/postgrest-js/dist
            packages/core/realtime-js/dist
            packages/core/storage-js/dist
            packages/core/supabase-js/dist

      - name: Upload UMD build
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: supabase-umd
          path: packages/core/supabase-js/dist/umd/supabase.js

  test:
    name: Unit + Type Check / Node.js ${{ matrix.node }} / OS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: build-package
    strategy:
      matrix:
        node: [20]
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check + Unit Tests + Coverage
        run: npx nx run-many --targets=test:types,test:coverage --projects=supabase-js

      - name: Upload coverage results to Coveralls
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/supabase-js/test/coverage/lcov.info
          parallel: true
          flag-name: supabase-js
          fail-on-error: false
        continue-on-error: true

  module-resolution:
    name: Module Resolution Tests
    runs-on: ubuntu-latest
    needs: build-package
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: packages-dist
          path: ./packages/core

      - name: Validate package exports (attw)
        run: npx nx test:exports supabase-js

      - name: Test ESM imports
        run: npx nx test:esm supabase-js

      - name: Test CJS requires
        run: npx nx test:cjs supabase-js
