name: Unpublish 2.92.0
# Temporary workflow to unpublish version 2.92.0

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to unpublish (e.g., 2.92.0)'
        required: true
        type: string
        default: '2.92.0'

env:
  NODE_VERSION: '20'

jobs:
  unpublish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Check if actor is member of admin or sdk team
        id: team-check
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const org = 'supabase'
            const { actor } = context

            async function isTeamMember(team_slug) {
              try {
                const res = await github.rest.teams.getMembershipForUserInOrg({
                  org,
                  team_slug,
                  username: actor,
                })
                return res && res.status === 200
              } catch (_) {
                return false
              }
            }
            const isAdmin = await isTeamMember('admin')
            const isSdk = await isTeamMember('sdk')
            const isMember = isAdmin || isSdk
            core.setOutput('is_team_member', isMember ? 'true' : 'false')

      - name: Fail if not authorized
        if: ${{ steps.team-check.outputs.is_team_member != 'true' }}
        run: |
          echo "You must be a member of @supabase/admin or @supabase/sdk."
          exit 1

      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Validate version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Must be in format X.Y.Z (e.g., 2.92.0)"
            exit 1
          fi

          echo "CLEAN_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Unpublish packages
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          VERSION="${{ env.CLEAN_VERSION }}"
          PACKAGES="supabase-js auth-js postgrest-js realtime-js storage-js functions-js gotrue-js"

          echo "âš ï¸  Unpublishing version $VERSION from all packages..."
          echo ""

          FAILED=()
          SUCCEEDED=()

          for pkg in $PACKAGES; do
            echo "ðŸ“¦ Unpublishing @supabase/$pkg@$VERSION..."
            if npm unpublish @supabase/$pkg@$VERSION --force 2>&1; then
              echo "âœ… @supabase/$pkg@$VERSION unpublished"
              SUCCEEDED+=("$pkg")
            else
              echo "âš ï¸  Failed to unpublish @supabase/$pkg@$VERSION (may not exist)"
              FAILED+=("$pkg")
            fi
            echo ""
          done

          echo "========================================="
          echo "SUMMARY"
          echo "========================================="
          echo "âœ… Succeeded: ${#SUCCEEDED[@]} packages"
          for pkg in "${SUCCEEDED[@]}"; do
            echo "   - @supabase/$pkg"
          done

          if [ ${#FAILED[@]} -gt 0 ]; then
            echo ""
            echo "âš ï¸  Failed/Skipped: ${#FAILED[@]} packages"
            for pkg in "${FAILED[@]}"; do
              echo "   - @supabase/$pkg"
            done
          fi

      - name: Summary
        if: ${{ success() }}
        run: |
          echo "## âœ… Unpublish Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version unpublished:** \`${{ env.CLEAN_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages processed:** All @supabase/* packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** This branch should be deleted after this workflow completes." >> $GITHUB_STEP_SUMMARY
