name: Unpublish 2 Package Versions

on:
  push:
    branches:
      - chore/unpublish-packages
  pull_request:
    branches:
      - chore/unpublish-packages
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  unpublish-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Check if actor is member of admin or sdk team
        id: team-check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const org = 'supabase'
            const { actor } = context

            async function isTeamMember(team_slug) {
              try {
                const res = await github.rest.teams.getMembershipForUserInOrg({
                  org,
                  team_slug,
                  username: actor,
                })
                return res && res.status === 200
              } catch (_) {
                return false
              }
            }
            const isAdmin = await isTeamMember('admin')
            const isSdk = await isTeamMember('sdk')
            const isMember = isAdmin || isSdk
            core.setOutput('is_team_member', isMember ? 'true' : 'false')

      - name: Fail if not authorized
        if: ${{ steps.team-check.outputs.is_team_member != 'true' }}
        run: |
          echo "‚ùå You must be a member of @supabase/admin or @supabase/sdk."
          exit 1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Tag version 2.94.1 as latest
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          PACKAGES=(
            "@supabase/auth-js"
            "@supabase/supabase-js"
            "@supabase/functions-js"
            "@supabase/realtime-js"
            "@supabase/postgrest-js"
            "@supabase/storage-js"
            "@supabase/gotrue-js"
          )

          echo "Tagging version 2.94.1 as latest for all packages"
          echo ""

          for package in "${PACKAGES[@]}"; do
            echo -n "üì¶ $package@2.94.1 ‚Üí latest... "
            if npm dist-tag add "${package}@2.94.1" latest 2>&1; then
              echo "‚úÖ"
            else
              echo "‚ùå Failed"
              exit 1
            fi
          done

          echo ""
          echo "‚úÖ All packages tagged with latest"

      - name: Unpublish versions 2.95.0 and 2.95.1
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          PACKAGES=(
            "@supabase/auth-js"
            "@supabase/supabase-js"
            "@supabase/functions-js"
            "@supabase/realtime-js"
            "@supabase/postgrest-js"
            "@supabase/storage-js"
            "@supabase/gotrue-js"
          )

          VERSIONS=("2.95.0" "2.95.1")

          echo "Unpublishing versions: ${VERSIONS[*]}"
          echo "From packages: ${#PACKAGES[@]} total"
          echo ""

          for package in "${PACKAGES[@]}"; do
            echo "üì¶ $package"
            for version in "${VERSIONS[@]}"; do
              echo -n "  Unpublishing ${version}... "
              if npm unpublish "${package}@${version}" --force 2>&1; then
                echo "‚úÖ"
              else
                echo "‚ö†Ô∏è (may not exist or already unpublished)"
              fi
            done
          done

          echo ""
          echo "‚úÖ Complete"
