name: Core packages tests
# Reusable workflow - called by ci.yml (PRs) and publish.yml (master)

on:
  workflow_call:

permissions:
  actions: read
  contents: read

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Detect which packages are affected — gates downstream infra-heavy jobs
  # ─────────────────────────────────────────────────────────────────────────────
  check-affected:
    name: Detect Affected Packages
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.affected.outputs.auth }}
      storage: ${{ steps.affected.outputs.storage }}
      postgrest: ${{ steps.affected.outputs.postgrest }}
      functions: ${{ steps.affected.outputs.functions }}
      realtime: ${{ steps.affected.outputs.realtime }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0
      - name: Detect affected packages
        id: affected
        run: |
          if ! AFFECTED=$(npx nx show projects --affected 2>&1); then
            echo "❌ Failed to detect affected projects:"
            echo "$AFFECTED"
            exit 1
          fi
          echo "Affected projects: $AFFECTED"
          echo "auth=$(echo "$AFFECTED"   | grep -q 'auth-js'      && echo 1 || echo 0)" >> $GITHUB_OUTPUT
          echo "storage=$(echo "$AFFECTED" | grep -q 'storage-js'   && echo 1 || echo 0)" >> $GITHUB_OUTPUT
          echo "postgrest=$(echo "$AFFECTED" | grep -q 'postgrest-js' && echo 1 || echo 0)" >> $GITHUB_OUTPUT
          echo "functions=$(echo "$AFFECTED" | grep -q 'functions-js' && echo 1 || echo 0)" >> $GITHUB_OUTPUT
          echo "realtime=$(echo "$AFFECTED"  | grep -q 'realtime-js'  && echo 1 || echo 0)" >> $GITHUB_OUTPUT

  # ─────────────────────────────────────────────────────────────────────────────
  # Build all affected packages + common type checks (always runs)
  # ─────────────────────────────────────────────────────────────────────────────
  build:
    name: Build and Common Checks
    runs-on: ubuntu-latest
    needs: check-affected
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0
      - name: Check common types are in sync
        run: npm run codegen:check
      - name: Build affected packages
        run: npx nx affected --target=build
      - name: Generate docs json for affected packages
        run: npx nx affected --target=docs:json

  # ─────────────────────────────────────────────────────────────────────────────
  # Fast tests: functions-js and realtime-js (no Docker, runs in parallel)
  # ─────────────────────────────────────────────────────────────────────────────
  test-fast:
    name: Test functions-js and realtime-js
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.functions != '0' || needs.check-affected.outputs.realtime != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0
      - name: Run test:ci for affected packages
        run: npx nx affected --target=test:ci
        timeout-minutes: 15
      - name: Upload coverage for functions-js
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/functions-js/coverage/lcov.info
          parallel: true
          flag-name: functions-js
          fail-on-error: false
        continue-on-error: true
      - name: Upload coverage for realtime-js
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/realtime-js/coverage/lcov.info
          parallel: true
          flag-name: realtime-js
          fail-on-error: false
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # auth-js CLI tests — runs in parallel with test-storage, Docker image caching
  # ─────────────────────────────────────────────────────────────────────────────
  test-auth-cli:
    name: Test auth-js (Supabase CLI)
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.auth != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Cache Supabase Docker images
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/supabase-docker-images
          key: supabase-docker-auth-${{ hashFiles('package.json', 'packages/core/auth-js/test/supabase/**') }}
      - name: Load cached Docker images
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: |
          for f in /tmp/supabase-docker-images/*.tar.zst; do
            [ -f "$f" ] && zstd -d --stdout "$f" | docker image load
          done
      - name: Generate RSA signing keys for auth-js tests
        run: node packages/core/auth-js/test/generate-signing-keys.js
      - name: Run auth-js tests with Supabase CLI
        run: npx nx run auth-js:test:auth
        timeout-minutes: 10
      - name: Save Docker images to cache
        if: steps.docker-cache.outputs.cache-hit != 'true' && !cancelled()
        run: |
          mkdir -p /tmp/supabase-docker-images
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep -v '<none>' \
            | grep -E 'supabase|postgrest|gotrue|storage-api|imgproxy|kong|inbucket|deno' \
            | while read img; do
                name=$(echo "$img" | tr '/:' '_')
                docker image save "$img" | zstd -T0 -3 -o "/tmp/supabase-docker-images/${name}.tar.zst"
              done
      - name: Upload coverage for auth-js
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/auth-js/coverage/lcov.info
          parallel: true
          flag-name: auth-js
          fail-on-error: false
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # storage-js tests — runs in parallel with test-auth-cli, Docker image caching
  # ─────────────────────────────────────────────────────────────────────────────
  test-storage:
    name: Test storage-js
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.storage != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Cache Supabase Docker images
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/supabase-docker-images
          key: supabase-docker-storage-${{ hashFiles('package.json', 'packages/core/storage-js/test/supabase/**') }}
      - name: Load cached Docker images
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: |
          for f in /tmp/supabase-docker-images/*.tar.zst; do
            [ -f "$f" ] && zstd -d --stdout "$f" | docker image load
          done
      - name: Run storage-js tests
        run: npx nx run storage-js:test:storage
        timeout-minutes: 15
      - name: Save Docker images to cache
        if: steps.docker-cache.outputs.cache-hit != 'true' && !cancelled()
        run: |
          mkdir -p /tmp/supabase-docker-images
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep -v '<none>' \
            | grep -E 'supabase|postgrest|gotrue|storage-api|imgproxy|kong|inbucket|deno' \
            | while read img; do
                name=$(echo "$img" | tr '/:' '_')
                docker image save "$img" | zstd -T0 -3 -o "/tmp/supabase-docker-images/${name}.tar.zst"
              done
      - name: Upload coverage for storage-js
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/storage-js/coverage/lcov.info
          parallel: true
          flag-name: storage-js
          fail-on-error: false
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # auth-js Docker tests — full coverage, separate job (gated on affected)
  # ─────────────────────────────────────────────────────────────────────────────
  test-auth-js-docker:
    name: Test auth-js (Docker - Full Coverage)
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.auth != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Cache Supabase Docker images
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/supabase-docker-images
          key: supabase-docker-auth-infra-${{ hashFiles('package.json', 'packages/core/auth-js/infra/**') }}
      - name: Load cached Docker images
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: |
          for f in /tmp/supabase-docker-images/*.tar.zst; do
            [ -f "$f" ] && zstd -d --stdout "$f" | docker image load
          done
      - name: Generate RSA signing keys for auth-js Docker tests
        run: node packages/core/auth-js/test/generate-signing-keys.js
      - name: Run auth-js Docker tests
        run: npx nx run auth-js:test:docker
        timeout-minutes: 10
      - name: Save Docker images to cache
        if: steps.docker-cache.outputs.cache-hit != 'true' && !cancelled()
        run: |
          mkdir -p /tmp/supabase-docker-images
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep -v '<none>' \
            | grep -E 'supabase|postgrest|gotrue|storage-api|imgproxy|kong|inbucket|deno' \
            | while read img; do
                name=$(echo "$img" | tr '/:' '_')
                docker image save "$img" | zstd -T0 -3 -o "/tmp/supabase-docker-images/${name}.tar.zst"
              done
      # Note: Docker test coverage is not uploaded to Coveralls
      # The regular auth-js tests provide comprehensive coverage reporting
      # Docker tests verify integration scenarios but don't need separate coverage tracking

  # ─────────────────────────────────────────────────────────────────────────────
  # postgrest-js tests + codegen check (merged, gated on affected, Docker cached)
  # ─────────────────────────────────────────────────────────────────────────────
  test-postgrest-js:
    name: Test postgrest-js
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.postgrest != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Cache Supabase Docker images
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/supabase-docker-images
          key: supabase-docker-postgrest-${{ hashFiles('package.json', 'packages/core/postgrest-js/test/**') }}
      - name: Load cached Docker images
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: |
          for f in /tmp/supabase-docker-images/*.tar.zst; do
            [ -f "$f" ] && zstd -d --stdout "$f" | docker image load
          done
      - name: Run postgrest-js integration tests
        run: npx nx run postgrest-js:test:ci:postgrest
        timeout-minutes: 10
      - name: Run postgrest-js type tests
        run: npx nx run postgrest-js:test:types:ci
        timeout-minutes: 15
      - name: Save Docker images to cache
        if: steps.docker-cache.outputs.cache-hit != 'true' && !cancelled()
        run: |
          mkdir -p /tmp/supabase-docker-images
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep -v '<none>' \
            | grep -E 'supabase|postgrest|gotrue|storage-api|imgproxy|kong|inbucket|deno' \
            | while read img; do
                name=$(echo "$img" | tr '/:' '_')
                docker image save "$img" | zstd -T0 -3 -o "/tmp/supabase-docker-images/${name}.tar.zst"
              done
      - name: Check if database schema changed
        id: check_codegen
        run: |
          BASE_REF="${{ github.base_ref }}"
          BASE_REF="${BASE_REF:-master}"
          git fetch origin "$BASE_REF" 2>/dev/null || true
          if git diff --name-only "origin/${BASE_REF}...HEAD" 2>/dev/null | grep -q "packages/core/postgrest-js/test/db/"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Verify generated types are in sync
        if: steps.check_codegen.outputs.changed == 'true'
        run: npm run codegen:check:postgrest
        timeout-minutes: 5
      - name: Skip codegen check
        if: steps.check_codegen.outputs.changed != 'true'
        run: echo "⏭️  Skipping codegen check — no database schema changes detected"
      - name: Upload coverage for postgrest-js
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/postgrest-js/coverage/lcov.info
          parallel: true
          flag-name: postgrest-js
          fail-on-error: false
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgREST v12 backward compatibility tests
  # TODO (@mandarini): Remove this job when v3 ships (mid 2026)
  # ─────────────────────────────────────────────────────────────────────────────
  test-postgrest-js-v12:
    name: Test postgrest-js v12 compat
    runs-on: ubuntu-latest
    needs: [check-affected, build]
    if: needs.check-affected.outputs.postgrest != '0'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Cache Supabase Docker images
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/supabase-docker-images
          key: supabase-docker-postgrest-v12-${{ hashFiles('package.json', 'packages/core/postgrest-js/test/v12/**') }}
      - name: Load cached Docker images
        if: steps.docker-cache.outputs.cache-hit == 'true'
        run: |
          for f in /tmp/supabase-docker-images/*.tar.zst; do
            [ -f "$f" ] && zstd -d --stdout "$f" | docker image load
          done
      - name: Run v12 compat tests
        run: npx nx run postgrest-js:test:ci:v12
        timeout-minutes: 5
      - name: Save Docker images to cache
        if: steps.docker-cache.outputs.cache-hit != 'true' && !cancelled()
        run: |
          mkdir -p /tmp/supabase-docker-images
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep -v '<none>' \
            | grep -E 'supabase|postgrest|gotrue|storage-api|imgproxy|kong|inbucket|deno' \
            | while read img; do
                name=$(echo "$img" | tr '/:' '_')
                docker image save "$img" | zstd -T0 -3 -o "/tmp/supabase-docker-images/${name}.tar.zst"
              done

  # ─────────────────────────────────────────────────────────────────────────────
  # Finalize Coveralls parallel build — must run after all coverage uploads
  # ─────────────────────────────────────────────────────────────────────────────
  coverage-report:
    name: Finalize Coverage Report
    runs-on: ubuntu-latest
    if: always()
    needs: [test-fast, test-auth-cli, test-storage, test-postgrest-js]
    steps:
      - uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Summary — required status check; passes when all jobs succeed or are skipped
  # ─────────────────────────────────────────────────────────────────────────────
  all-core-tests-pass:
    name: All Core Package Tests Pass
    runs-on: ubuntu-latest
    if: always()
    needs:
      [
        check-affected,
        build,
        test-fast,
        test-auth-cli,
        test-storage,
        test-auth-js-docker,
        test-postgrest-js,
        test-postgrest-js-v12,
      ]
    steps:
      - name: Summary
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "❌ Some tests failed or were cancelled"
            exit 1
          fi
          echo "✅ All core package tests passed successfully!"
