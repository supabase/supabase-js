name: Core packages tests
# Reusable workflow - called by ci.yml (PRs) and publish.yml (master)

on:
  workflow_call:

permissions:
  actions: read
  contents: read

jobs:
  setup-build-test-node-20:
    name: Run tests for Node.js 20
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      # Cache node_modules
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0

      # Prepend any command with "nx-cloud record --" to record its logs to Nx Cloud
      # - run: npx nx-cloud record -- echo Hello World
      # When you enable task distribution, run the e2e-ci task instead of e2e
      - name: Check common types are in sync
        run: npm run codegen:check

      - name: Build affected packages
        run: npx nx affected --target=build

      - name: Generate docs json for affected packages
        run: npx nx affected --target=docs:json

      - name: Run test:ci for affected packages
        run: npx nx affected --target=test:ci
        timeout-minutes: 15

      - name: Upload coverage for functions-js (if affected)
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/functions-js/coverage/lcov.info
          parallel: true
          flag-name: functions-js
          fail-on-error: false
        continue-on-error: true

      - name: Upload coverage for realtime-js (if affected)
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/realtime-js/coverage/lcov.info
          parallel: true
          flag-name: realtime-js
          fail-on-error: false
        continue-on-error: true

      - name: Generate RSA signing keys for auth-js tests
        run: node packages/core/auth-js/test/generate-signing-keys.js

      - name: Run auth-js tests with Supabase CLI (if affected)
        run: npx nx affected --target=test:auth
        timeout-minutes: 10

      - name: Upload coverage for auth-js (if affected)
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/auth-js/coverage/lcov.info
          parallel: true
          flag-name: auth-js
          fail-on-error: false
        continue-on-error: true

      - name: Setup Supabase CLI (for storage-js tests)
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Run storage-js tests (if affected)
        run: npx nx affected --target=test:storage

      - name: Upload coverage for storage-js (if affected)
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/storage-js/coverage/lcov.info
          parallel: true
          flag-name: storage-js
          fail-on-error: false
        continue-on-error: true

  # Separate job for auth-js Docker tests (full coverage including edge cases)
  test-auth-js-docker:
    name: Test auth-js (Docker - Full Coverage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@v4

      - name: Generate RSA signing keys for auth-js Docker tests
        run: node packages/core/auth-js/test/generate-signing-keys.js

      - name: Run auth-js Docker tests (if affected)
        run: npx nx affected --target=test:docker --projects=@supabase/auth-js
        timeout-minutes: 10

      # Note: Docker test coverage is not uploaded to Coveralls
      # The regular auth-js tests provide comprehensive coverage reporting
      # Docker tests verify integration scenarios but don't need separate coverage tracking

  # Separate job for postgrest-js tests (Docker-based, retriable)
  test-postgrest-js:
    name: Test postgrest-js
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0

      - name: Setup Supabase CLI (for postgrest-js tests)
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Run postgrest-js integration tests (if affected)
        run: npx nx affected --target=test:ci:postgrest
        timeout-minutes: 10

      - name: Run postgrest-js type tests (if affected)
        run: npx nx affected --target=test:types:ci
        timeout-minutes: 15

      - name: Upload coverage for postgrest-js (if affected)
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2.3.7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./packages/core/postgrest-js/coverage/lcov.info
          parallel: true
          flag-name: postgrest-js
          fail-on-error: false
        continue-on-error: true

  # Separate job for slow type generation check (runs in parallel)
  check-postgrest-generated-types:
    name: Check Postgrest Generated Types
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI (for checking generated types)
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Check if database schema changed
        id: check_changes
        run: |
          git fetch origin ${{ github.base_ref }}
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "packages/core/postgrest-js/test/db/"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify generated types are in sync
        if: steps.check_changes.outputs.changed == 'true'
        run: npm run codegen:check:postgrest
        timeout-minutes: 5

      - name: Skip check
        if: steps.check_changes.outputs.changed != 'true'
        run: echo "⏭️  Skipping - no database schema changes detected"

  # PostgREST v12 backward compatibility tests
  # TODO (@mandarini): Remove this job when v3 ships (early 2025)
  test-postgrest-js-v12:
    name: Test postgrest-js v12 compat
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          filter: tree:0
          fetch-depth: 0
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - uses: nrwl/nx-set-shas@3e9ad7370203c1e93d109be57f3b72eb0eb511b1 # v4.4.0

      - name: Run v12 compat tests (if affected)
        run: npx nx affected --target=test:ci:v12
        timeout-minutes: 5

  # SUMMARY JOB
  all-core-tests-pass:
    name: All Core Package Tests Pass
    runs-on: ubuntu-latest
    needs:
      [
        setup-build-test-node-20,
        test-auth-js-docker,
        test-postgrest-js,
        check-postgrest-generated-types,
        test-postgrest-js-v12,
      ]
    steps:
      - name: Summary
        run: echo "✅ All core package tests passed successfully!"
